<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('project-form');
        const tableBody = document.querySelector('#projects-table tbody');
        const exportBtn = document.getElementById('export-excel');
        const cancelEditBtn = document.getElementById('cancel-edit');
        let editMode = false;
        let projects = []; // Array global para manejar datos

        // URL del web app de Google Apps Script (reemplaza con tu URL real si cambia)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxo3dhA7cC0KnIZvRVgH4OMoRkc4RPTey4gxRckWqqtlxJM_g15gU91sMNMEV0_zG_N0w/exec';

        // Carga inicial de proyectos desde Sheets
        loadProjects();

        // Evento para guardar/actualizar
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const project = {
                id: formData.get('edit-id') || Date.now(),
                proyecto: formData.get('proyecto').trim(),
                responsable: formData.get('responsable').trim(),
                pin: formData.get('pin').trim(),
                cargo: formData.get('cargo').trim(),
                fecha_inicio: formData.get('fecha_inicio'),
                fecha_fin: formData.get('fecha_fin'),
                dias: calculateDays(formData.get('fecha_inicio'), formData.get('fecha_fin')),
                action: editMode ? 'update' : 'add'
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(project)
                });
                const result = await response.json();

                if (result.success) {
                    alert(editMode ? 'Proyecto actualizado exitosamente.' : 'Proyecto guardado exitosamente.');
                    if (editMode) {
                        updateProjectLocal(project);
                    } else {
                        addProjectLocal(project);
                    }
                    resetForm();
                    // No necesitas refreshTable() aquí, ya que update/add local lo maneja
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar. Verifica la conexión y la URL del script.');
            }
        });

        // Función para cargar proyectos desde Sheets
        async function loadProjects() {
            try {
                const response = await fetch(SCRIPT_URL); // doGet por defecto
                const result = await response.json();
                if (result.success) {
                    projects = result.projects || [];
                    tableBody.innerHTML = ''; // Limpia tabla antes de agregar
                    projects.forEach(addProjectToTable); // Solo agrega a tabla, no guarda individual
                    saveToLocalStorage(projects); // Guarda el array completo
                } else {
                    console.error('Error cargando:', result.error);
                    // Fallback a localStorage
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('Error en loadProjects:', error);
                loadFromLocalStorage();
            }
        }

        // Fallback: Carga desde localStorage
        function loadFromLocalStorage() {
            projects = JSON.parse(localStorage.getItem('projects')) || [];
            tableBody.innerHTML = '';
            projects.forEach(addProjectToTable);
        }

        // Agregar a tabla (solo tabla, el array se maneja en el caller)
        function addProjectToTable(project) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-100';
            row.dataset.id = project.id;
            row.innerHTML = `
                <td class="py-3 px-6">${project.id}</td>
                <td class="py-3 px-6">${project.proyecto}</td>
                <td class="py-3 px-6">${project.responsable}</td>
                <td class="py-3 px-6">${project.pin}</td> <!-- Opcional: ${project.pin ? '***' : ''} para ocultar -->
                <td class="py-3 px-6">${project.cargo}</td>
                <td class="py-3 px-6">${project.fecha_inicio}</td>
                <td class="py-3 px-6">${project.fecha_fin}</td>
                <td class="py-3 px-6">${project.dias}</td>
                <td class="py-3 px-6">
                    <button class="edit-btn bg-blue-600 text-white py-1 px-2 rounded-md hover:bg-blue-700 mr-2">Editar</button>
                    <button class="delete-btn bg-red-600 text-white py-1 px-2 rounded-md hover:bg-red-700">Eliminar</button>
                </td>
            `;
            tableBody.appendChild(row);

            row.querySelector('.edit-btn').addEventListener('click', () => editProject(project.id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteProject(project.id));
        }

        // Agregar nuevo (actualizado: empuja al array y guarda)
        function addProjectLocal(project) {
            projects.push(project);
            saveToLocalStorage(projects);
            addProjectToTable(project);
        }

        // Actualizar local
        function updateProjectLocal(updatedProject) {
            const index = projects.findIndex(p => p.id == updatedProject.id); // == para flexibilidad
            if (index !== -1) {
                projects[index] = updatedProject;
                saveToLocalStorage(projects);
                refreshTable(); // Refresca la tabla completa para consistencia
            }
        }

        // Eliminar (llama al backend y refresca)
        window.deleteProject = async (id) => {
            if (!confirm('¿Estás seguro de eliminar este proyecto?')) return;
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, action: 'delete' })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Proyecto eliminado exitosamente.');
                    refreshTable(); // Recarga desde Sheets
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error eliminando:', error);
                alert('Error al eliminar.');
            }
        };

        // Editar
        window.editProject = (id) => {
            const project = projects.find(p => p.id == id);
            if (project) {
                document.getElementById('edit-id').value = project.id;
                document.getElementById('proyecto').value = project.proyecto;
                document.getElementById('responsable').value = project.responsable;
                document.getElementById('pin').value = project.pin;
                document.getElementById('cargo').value = project.cargo;
                document.getElementById('fecha_inicio').value = project.fecha_inicio;
                document.getElementById('fecha_fin').value = project.fecha_fin;
                form.querySelector('button[type="submit"]').textContent = 'Actualizar Proyecto';
                cancelEditBtn.classList.remove('hidden');
                editMode = true;
            }
        };

        // Calcular días
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Guardar array completo en localStorage
        function saveToLocalStorage(projectsArray) {
            localStorage.setItem('projects', JSON.stringify(projectsArray));
        }

        // Reset form
        function resetForm() {
            form.reset();
            document.getElementById('edit-id').value = '';
            form.querySelector('button[type="submit"]').textContent = 'Guardar Proyecto';
            cancelEditBtn.classList.add('hidden');
            editMode = false;
        }

        // Refrescar tabla (limpia y recarga desde Sheets)
        function refreshTable() {
            tableBody.innerHTML = '';
            loadProjects();
        }

        // Evento cancelar
        cancelEditBtn.addEventListener('click', resetForm);

        // Evento exportar a Excel (del código original, sin cambios)
        exportBtn.addEventListener('click', () => {
            const table = document.getElementById('projects-table');
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);

            // Definir columnas para ajustar el ancho
            ws['!cols'] = [
                { wch: 10 }, // ID
                { wch: 20 }, // Proyecto
                { wch: 20 }, // Responsable
                { wch: 10 }, // PIN
                { wch: 15 }, // Cargo
                { wch: 15 }, // Fecha Inicio
                { wch: 15 }, // Fecha Fin
                { wch: 10 }, // Nº Días
                { wch: 15 }  // Acciones (no se exporta)
            ];

            // Aplicar formato básico a los encabezados
            const headers = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1'];
            headers.forEach(cell => {
                if (ws[cell]) {
                    ws[cell].s = {
                        font: { bold: true },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                }
            });

            // Eliminar la columna de acciones en la exportación
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = range.s.r; row <= range.e.r; row++) {
                const actionCell = XLSX.utils.encode_cell({ r: row, c: 8 }); // Columna I
                delete ws[actionCell];
            }
            ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: range.e.r, c: 7 } });

            // Aplicar formato a las celdas
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= 7; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = { alignment: { horizontal: 'left', vertical: 'center' } };
                    if (col === 5 || col === 6) ws[cellAddress].z = 'yyyy-mm-dd'; // Fechas
                    if (col === 7) { ws[cellAddress].z = '0'; ws[cellAddress].t = 'n'; } // Números
                }
            }

            // Definir tabla de Excel
            ws['!autofilter'] = { ref: `A1:H${range.e.r + 1}` };
            ws['!tables'] = [{
                ref: `A1:H${range.e.r + 1}`, name: 'TablaProyectos', displayName: 'TablaProyectos', headerRowCount: 1,
                totalsRowCount: 0, styleInfo: { name: 'TableStyleMedium2', showFirstColumn: false, showLastColumn: false, showRowStripes: true, showColumnStripes: false }
            }];

            XLSX.utils.book_append_sheet(wb, ws, 'Proyectos');
            XLSX.writeFile(wb, 'proyectos_registrados.xlsx');
        });
    });
</script>
